import { useEffect, useState } from "react";
import { useParams } from "react-router-dom";

import { Layout } from "./components/Layout";
import { TutorStudentList } from "./components/TutorStudentList";
import { TutorTemplateList } from "./components/TutorTemplateList";
import { WeeklyCalendar } from "./components/WeeklyCalendar";
import { WeekData } from "../types/weekly";

function getSundayStart(date: Date): string {
  const d = new Date(date);
  const day = d.getDay(); // Sunday=0
  const sunday = new Date(d);
  sunday.setDate(d.getDate() - day);
  return sunday.toISOString().slice(0, 10);
}

export function TutorHomePage() {
  const { id } = useParams();
  const [tutor, setTutor] = useState<any>(null);
  const [week, setWeek] = useState<WeekData | null>(null);

  useEffect(() => {
    fetch(`/api/tutors/${id}/home/`)
      .then(res => res.json())
      .then(data => setTutor(data));
  }, [id]);

  useEffect(() => {
    loadCalendar();
  }, []);

  const loadCalendar = async () => {
    const start = getSundayStart(new Date());

    const res = await fetch(
      `/api/tutors/${id}/weekly_slots/?week_start=${start}&tutor_view=true`
    );

    const data = await res.json();
    setWeek(data.week);
  };

  if (!tutor) return <div className="container mt-4">Loadingâ€¦</div>;

  return (
  <Layout>
    <div className="container mt-4">
      <h2>{tutor.name}</h2>
      <p>{tutor.email}</p>

      <hr />

      <h4 className="mt-4">Students</h4>
      <div className="d-flex justify-content-between align-items-center mb-3">
          <a className="btn btn-outline-primary btn-sm" href={`/admin/students/new?tutor=${id}`}>
            + New Student
          </a>
        </div>

      <TutorStudentList tutorId={id!} />

      <hr />
      <a className="btn btn-outline-primary" href={`/tutor/${id}/schedule`}>Adjust Weekly Schedule</a>

        <div style={{ marginBottom: "1.5rem", fontSize: "1.4rem", fontWeight: 600 }}>
          Your Calendar
        </div>



      {week && (
        <WeeklyCalendar
          week={week}
          mode="tutor-schedule"
          showAllBookingLabels={true}
        />
      )}

    </div>


  </Layout>

  );
}