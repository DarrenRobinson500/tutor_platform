class TemplateViewSet(viewsets.ModelViewSet):
    queryset = Template.objects.all()
    serializer_class = TemplateSerializer
    permission_classes = [IsAuthenticated]

    @action(detail=False, methods=["post"])
    def autosave(self, request):
        content = request.data.get("content", "")
        template_id = request.data.get("templateId") or request.data.get("id")
        # Normalize invalid IDs
        invalid_ids = [None, "", "undefined", "new"]
        if template_id in invalid_ids:
            template = Template.objects.create(
                content=content
            )
            return Response({"ok": True, "id": template.id})

        # If no template_id, do nothing and return success
        if not template_id:
            print("No success trying to create a tempate id, Template ID:", template_id)
            return Response({"ok": True})

        # If template_id exists, update the template
        try:
            template = Template.objects.get(pk=template_id)
            template.content = content
            template.save()
            # print(f"AUTOSAVED TEMPLATE {template_id}")
            return Response({"ok": True})
        except Template.DoesNotExist:
            template = Template.objects.create(content=content)
            return Response({"ok": True})

    @action(detail=False, methods=["post"])
    def preview(self, request):
        content = request.data.get("content", "")

        # Step 1: Try YAML
        try:
            parsed = yaml.safe_load(content)
        except Exception as e:
            return Response(
                {
                    "ok": False,
                    "preview": {
                        "question": "",
                        "answers": [],
                        "solution": "",
                        "diagram_svg": "",
                        "diagram_code": "",
                        "substituted_yaml": content,
                        "params": {},
                        "errors": [f"YAML error: {str(e)}"]
                    },
                    "error": f"YAML error: {str(e)}"
                },
                status=status.HTTP_400_BAD_REQUEST
            )

        # Step 2: Deep validation (your rules)
        errors = validate_template(parsed)
        if errors:
            return Response(
                {"ok": False, "preview": parsed, "error": errors},
                status=status.HTTP_400_BAD_REQUEST
            )

        # Step 3: Render preview (your logic)
        MAX_ATTEMPTS = 5
        last_error = None

        for attempt in range(MAX_ATTEMPTS):
            try:
                preview = render_template_preview(parsed)
                print("PREVIEW RETURNED FROM BACKEND:", preview)

                return Response({"ok": True, "preview": preview})
            except Exception as e:
                import traceback
                print("\n--- PREVIEW ERROR ATTEMPT", attempt, "---")
                traceback.print_exc()
                last_error = traceback.format_exc()

        # If all attempts failed, return the last error
        return Response(
            {
                "ok": False,
                "preview": {
                    "question": "",
                    "answers": [],
                    "solution": "",
                    "diagram_svg": "",
                    "diagram_code": "",
                    "substituted_yaml": original_yaml_text if 'original_yaml_text' in locals() else content,
                    "params": generated_params if 'generated_params' in locals() else {},
                    "errors": [f"Failed after {MAX_ATTEMPTS} attempts: {last_error}"]
                },
                "error": f"Failed after {MAX_ATTEMPTS} attempts: {last_error}"
            },
            status=status.HTTP_400_BAD_REQUEST
        )

    @action(detail=False, methods=["post"])
    def generate(self, request):
        skill_id = request.data.get("skill_id")
        grade = request.data.get("grade")

        if not skill_id:
            return Response({"error": "skill_id missing"}, status=400)
        try:
            skill = Skill.objects.get(id=skill_id)
        except Skill.DoesNotExist:
            return Response({"error": "Skill not found"}, status=404)

        print(f"Skill: {skill.description}, Grade: {grade}")
        data = generate_template_content(skill.description, grade)
        print("AI Output:\n", data)

        created_templates = []

        for item in data:
            template = Template.objects.create(
                skill=skill,
                grade=grade,
                subject=item["title"],
                content=format_for_editor(item),
            )
            created_templates.append(template)

        # Return ONLY the first created template
        first = created_templates[0]
        update_matrix_cache_for_template_count(skill_id)

        return Response({
            "id": first.id,
            "subject": first.subject,
            "content": first.content,
            "skill": first.skill.id,
        })

    @action(detail=True, methods=["post"])
    def diagram(self, request, pk=None):
        template = self.get_object()
        svg = request.data.get("svg")

        if not svg:
            return Response({"error": "SVG missing"}, status=400)

        diagram, _ = TemplateDiagram.objects.update_or_create(
            template=template,
            defaults={"svg_spec": svg}
        )

        return Response({"ok": True})
