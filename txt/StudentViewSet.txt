class StudentViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = StudentProfile.objects.select_related("user").all()
    serializer_class = StudentSerializer
    permission_classes = [IsAuthenticated]

    @action(detail=True, methods=["get"])
    def home(self, request, pk=None):
        user = self.get_object()
        tutor = user.get_tutor()
        print("Student Home (user, tutor, tutor_id):", user, tutor, tutor.id if tutor else None)
        return Response({
            "id": user.id,
            "name": user.get_full_name() or user.username,
            "email": user.email,
            "tutor_id": tutor.id if tutor else None,
            "tutor_name": tutor.get_full_name() or tutor.username if tutor else None,
        })

    @action(detail=False, methods=["post"])
    def create_student(self, request):
        name = request.data.get("name")
        email = request.data.get("email")
        password = request.data.get("password") or User.objects.make_random_password()
        tutor_id = request.data.get("tutor_id")

        if not name or not email:
            return Response({"error": "Name and email are required"}, status=400)

        student = User.objects.create(
            username=email,
            email=email,
            first_name=name,
            role="student",
            password=make_password(password),
        )

        if tutor_id:
            TutorStudent.objects.create(
                tutor_id=tutor_id,
                student=student
            )

        return Response({
            "id": student.id,
            "name": student.first_name,
            "email": student.email,
            "password": password,  # shown once so admin can give it to the student
            "linked_to_tutor": tutor_id,

        })
