export async function apiFetch(url: string, options: any = {}) {
  const API_URL = process.env.REACT_APP_API_URL;
  const base = (API_URL ?? "").replace(/\/$/, "");

  console.log("API URL:", API_URL)
  const access = localStorage.getItem("access");

  const headers = {
    "Content-Type": "application/json",
    ...(options.headers || {}),
    ...(access ? { Authorization: `Bearer ${access}` } : {}),
  };

  // No access token → no refresh attempt
  if (!access) {
    return fetch(`${base}${url}`, {
      ...options,
      headers,
      credentials: "include",
    });
  }

  // First attempt
  let res = await fetch(`${API_URL}${url}`, {
    ...options,
    headers,
    credentials: "include",
  });

  // If expired → try refresh
  if (res.status === 401) {
    const refresh = localStorage.getItem("refresh");

    if (!refresh) {
      localStorage.removeItem("access");
      localStorage.removeItem("user");
      return res;
    }

    const refreshRes = await fetch(`${API_URL}/api/auth/refresh/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh }),
      credentials: "include",
    });

    if (!refreshRes.ok) {
      localStorage.removeItem("access");
      localStorage.removeItem("refresh");
      localStorage.removeItem("user");
      return res;
    }

    const data = await refreshRes.json();
    localStorage.setItem("access", data.access);

    const retryHeaders = {
      ...headers,
      Authorization: `Bearer ${data.access}`,
    };

    res = await fetch(`${API_URL}${url}`, {
      ...options,
      headers: retryHeaders,
      credentials: "include",
    });
  }

  return res;
}

export async function apiFetchJson(url: string, options: any = {}) {
  const res = await apiFetch(url, options);
  if (!res.ok) throw new Error(`API error: ${res.status}`);
  return res.json();
}